import{s as n}from"./supabase-BZnn04Q5.js";console.log("üöÄ Manager.ts y√ºkl…ônm…ôy…ô ba≈üladƒ±...");let d="active",r=null,w=[],f=null;const i=(s,e)=>{const a=document.getElementById("toast-container");if(!a)return;const t=document.createElement("div"),o=e==="success"?"border-l-4 border-green-500 text-green-700":"border-l-4 border-red-500 text-red-700";t.className=`bg-white p-4 rounded shadow-lg flex items-center gap-3 min-w-[300px] animate-[slideIn_0.3s_ease-out] ${o}`,t.innerHTML=`<span class="font-bold text-sm">${s}</span>`,a.appendChild(t),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>t.remove(),500)},3e3)};document.addEventListener("DOMContentLoaded",async()=>{const s=localStorage.getItem("admin_user");if(r=localStorage.getItem("school_id"),!s||!r){window.location.href="/";return}try{const a=document.getElementById("adminSchoolName");a&&(a.innerText="Y√ºkl…ônir...");const{data:t}=await n.from("schools").select("name").eq("id",r).single();if(a&&t){const o=t;a.innerText=o.name||"M…ôkt…ôb"}}catch(a){console.error(a)}_(),window.switchTab("active");const e=document.getElementById("searchInput");e&&e.addEventListener("input",a=>{const t=a.target.value.toLowerCase();if(!t){y(w);return}const o=w.filter(c=>JSON.stringify(c).toLowerCase().includes(t));y(o)})});var v;(v=document.getElementById("logoutBtn"))==null||v.addEventListener("click",()=>{localStorage.clear(),window.location.href="/"});window.switchTab=s=>{var t,o;d=s;const e=document.getElementById("searchInput");e&&(e.value=""),document.querySelectorAll('nav button[id^="tab-"]').forEach(c=>{c.classList.remove("bg-purple-50","text-primary"),c.classList.add("text-gray-500","hover:bg-gray-50")}),(t=document.getElementById(`tab-${s}`))==null||t.classList.add("bg-purple-50","text-primary"),(o=document.getElementById(`tab-${s}`))==null||o.classList.remove("text-gray-500");const a=document.getElementById("pageTitle");a&&(a.innerText=s.toUpperCase()),u()};async function u(){const s=document.getElementById("tableBody");if(!s)return;s.innerHTML='<tr><td colspan="5" class="p-10 text-center"><i class="fas fa-spinner fa-spin text-2xl text-primary"></i></td></tr>',M();let e=[],a=null;if(d==="students"){const t=await n.from("students").select("*").eq("school_id",r).order("full_name",{ascending:!0});e=t.data||[],a=t.error}else if(d==="books"){const t=await n.from("books").select("*").eq("school_id",r).order("title",{ascending:!0});e=t.data||[],a=t.error}else{let t=n.from("transactions").select("id, status, borrow_date, returned_date, secret_code, review_text, rating, is_review_approved, ai_analysis, ai_score, students(full_name, class_name), books(id, title)").eq("school_id",r).order("borrow_date",{ascending:!1});d==="pending"?t=t.eq("status","pending"):d==="active"?t=t.eq("status","active"):d==="returned"?t=t.eq("status","returned").limit(50):d==="reviews"&&(t=t.not("review_text","is",null));const o=await t;e=o.data||[],a=o.error}if(a){s.innerHTML=`<tr><td colspan="5" class="text-center text-red-500">X…ôta: ${a.message}</td></tr>`;return}w=e,_(),y(e)}function M(){const s=document.getElementById("tableHead");if(!s)return;let e="";d==="students"?e='<tr><th class="p-5">Ad Soyad</th><th class="p-5">Sinif</th><th class="p-5">Kod</th><th class="p-5">XP</th><th class="p-5 text-right">∆èm…ôliyyat</th></tr>':d==="books"?e='<tr><th class="p-5">Kitab Adƒ±</th><th class="p-5">M√º…ôllif</th><th class="p-5">Stok</th><th class="p-5">Oxunma</th><th class="p-5 text-right">∆èm…ôliyyat</th></tr>':e='<tr><th class="p-5">≈ûagird</th><th class="p-5">Kitab</th><th class="p-5">Tarix / Info</th><th class="p-5">Status</th><th class="p-5 text-right">∆èm…ôliyyat</th></tr>',s.innerHTML=e}function y(s){const e=document.getElementById("tableBody");if(!e)return;if(!s||s.length===0){e.innerHTML='<tr><td colspan="5" class="p-10 text-center text-gray-400 italic">M…ôlumat yoxdur</td></tr>';return}let a="";d==="students"?s.forEach(t=>{a+=`<tr class="hover:bg-gray-50 border-b border-gray-50"><td class="p-4 font-bold text-gray-800">${t.full_name}</td><td class="p-4">${t.class_name}</td><td class="p-4 font-mono text-purple-600">${t.student_code}</td><td class="p-4 font-bold text-yellow-500">${t.xp_points||0} XP</td><td class="p-4 text-right"><button onclick="window.openEditModal('student', '${t.id}')" class="text-blue-500 bg-blue-50 p-2 rounded mr-2"><i class="fas fa-edit"></i></button><button onclick="window.askDelete('student', '${t.id}')" class="text-red-500 bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button></td></tr>`}):d==="books"?s.forEach(t=>{a+=`<tr class="hover:bg-gray-50 border-b border-gray-50"><td class="p-4 font-bold text-gray-800">${t.title}</td><td class="p-4 text-gray-500">${t.author}</td><td class="p-4 font-bold text-blue-600">${t.quantity} …ôd…ôd</td><td class="p-4 text-gray-400">üî• ${t.borrow_count||0}</td><td class="p-4 text-right"><button onclick="window.openEditModal('book', '${t.id}')" class="text-blue-500 bg-blue-50 p-2 rounded mr-2"><i class="fas fa-edit"></i></button><button onclick="window.askDelete('book', '${t.id}')" class="text-red-500 bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button></td></tr>`}):s.forEach(t=>{const o=t.students,c=t.books,p=Array.isArray(o)?o[0]:o,l=Array.isArray(c)?c[0]:c,x=(l==null?void 0:l.id)||"",h=(p==null?void 0:p.full_name)||"---";let g="",b="";if(d==="reviews"){const m="‚≠ê".repeat(t.rating||0),q=t.ai_analysis?`<div class="mt-2 text-xs text-purple-600 bg-purple-50 p-2 rounded border border-purple-100 flex items-start gap-2"><i class="fas fa-robot mt-1"></i> <span><b>AI:</b> ${t.ai_analysis}</span></div>`:"",k=t.ai_score?`+${t.ai_score} XP`:"0 XP";let $=t.is_review_approved?'<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold mr-2">Yayƒ±ndadƒ±r</span>':'<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold mr-2">G√∂zl…ôyir</span>',B=t.is_review_approved?'<span class="text-xs text-gray-400 font-bold italic mr-2">T…ôsdiql…ônib</span>':`<button onclick="window.approveReview('${t.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-600 shadow-sm">T∆èSDƒ∞QL∆è (${k})</button>`;a+=`<tr class="hover:bg-yellow-50 border-b border-gray-50"><td class="p-4"><p class="font-bold text-gray-800">${h}</p></td><td class="p-4">${l==null?void 0:l.title}</td><td class="p-4" colspan="2"><div class="flex items-center mb-1">${$} <span class="text-xs text-yellow-500">${m}</span></div><p class="text-sm italic text-gray-600 bg-white p-2 rounded border">"${t.review_text}"</p>${q}</td><td class="p-4 text-right"><div class="flex justify-end gap-2"><button onclick="window.askDelete('review', '${t.id}')" class="text-red-500 bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>${B}</div></td></tr>`;return}if(t.status==="pending")g='<span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold">G√∂zl…ôyir</span>',b=`<button onclick="window.askDelete('request', '${t.id}')" class="text-red-500 bg-red-50 p-2 rounded mr-2"><i class="fas fa-times"></i></button><button onclick="window.approveRequest('${t.id}', '${x}')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">T∆èSDƒ∞QL∆è</button>`;else if(t.status==="active"){const m=10-Math.ceil(Math.abs(new Date().getTime()-new Date(t.borrow_date).getTime())/864e5);g=`<span class="${m>=0?"bg-green-100 text-green-700":"bg-red-100 text-red-700"} px-3 py-1 rounded-full text-xs font-bold">${m>=0?m+" g√ºn":Math.abs(m)+" g√ºn gec"}</span>`,b=`<button onclick="window.returnBook('${t.id}', '${x}')" class="border border-primary text-primary px-3 py-1 rounded text-xs font-bold">QAYTAR</button>`}else g=`<span class="text-xs font-mono text-primary font-bold">KOD: ${t.secret_code||"---"}</span>`,b='<i class="fas fa-check-double text-green-500"></i>';a+=`<tr class="hover:bg-gray-50 border-b border-gray-50"><td class="p-4"><p class="font-bold text-gray-800">${h}</p><p class="text-xs text-gray-400">${p==null?void 0:p.class_name}</p></td><td class="p-4">${l==null?void 0:l.title}</td><td class="p-4 text-xs">${new Date(t.borrow_date).toLocaleDateString("az-AZ")}</td><td class="p-4">${g}</td><td class="p-4 text-right">${b}</td></tr>`}),e.innerHTML=a}window.askDelete=(s,e)=>{console.log("Ask Delete:",s,e),f={type:s,id:e},window.openModal("confirmModal")};window.confirmAction=async()=>{if(!f)return;const{type:s,id:e}=f;let a=null;if(s==="student"){const{error:t}=await n.from("students").delete().eq("id",e);a=t}else if(s==="book"){const{error:t}=await n.from("books").delete().eq("id",e);a=t}else if(s==="review"){const{error:t}=await n.from("transactions").update({review_text:null,rating:null,is_review_approved:!1,ai_analysis:null,ai_score:0}).eq("id",e);a=t}else if(s==="request"){const{error:t}=await n.from("transactions").delete().eq("id",e);a=t}a?i("X…ôta: "+a.message,"error"):(i("Uƒüurla Silindi!","success"),u()),f=null,window.closeModal("confirmModal")};window.openModal=s=>{var e;(e=document.getElementById(s))==null||e.classList.remove("hidden"),s==="addStudentModal"&&document.getElementById("editStudentId").value};window.closeModal=s=>{var e;(e=document.getElementById(s))==null||e.classList.add("hidden"),s==="confirmModal"&&(f=null)};window.approveRequest=async(s,e)=>{if(!e)return;const{data:a}=await n.from("books").select("quantity").eq("id",e).single();if(!a||a.quantity<1)return i("Stokda yoxdur!","error");await n.from("books").update({quantity:a.quantity-1}).eq("id",e),await n.from("transactions").update({status:"active",borrow_date:new Date}).eq("id",s),i("Kitab verildi!","success"),u()};window.returnBook=async(s,e)=>{const a=Math.floor(1e4+Math.random()*9e4).toString();if(e){const{data:o}=await n.from("books").select("quantity").eq("id",e).single();o&&await n.from("books").update({quantity:o.quantity+1}).eq("id",e)}await n.from("transactions").update({status:"returned",returned_date:new Date,secret_code:a}).eq("id",s),i(`Kitab Qaytarƒ±ldƒ±! Kod: ${a}`,"success");const t=document.getElementById("secretCodeDisplay");t&&(t.innerText=a),window.openModal("codeModal"),u()};window.approveReview=async s=>{const{data:e}=await n.from("transactions").select("student_id, ai_score").eq("id",s).single();if(!e)return i("X…ôta!","error");const{error:a}=await n.from("transactions").update({is_review_approved:!0}).eq("id",s);if(a)i("X…ôta!","error");else{if(e.student_id&&e.ai_score>0){const{data:t}=await n.from("students").select("xp_points").eq("id",e.student_id).single();await n.from("students").update({xp_points:((t==null?void 0:t.xp_points)||0)+e.ai_score}).eq("id",e.student_id)}i("T…ôsdiql…ôndi!","success"),u()}};window.deleteReview=s=>window.askDelete("review",s);window.deleteItem=(s,e)=>window.askDelete(s,e);window.rejectRequest=s=>window.askDelete("request",s);window.openEditModal=(s,e)=>{w.find(t=>t.id===e)&&(s=="student"?window.openModal("addStudentModal"):window.openModal("addBookModal"))};window.saveStudent=async()=>{const s=document.getElementById("editStudentId").value,e=document.getElementById("newStudentName").value,a=document.getElementById("newStudentCode").value,t=document.getElementById("newStudentClass").value;if(!e)return i("Ad yazƒ±n","error");s?await n.from("students").update({full_name:e,class_name:t,student_code:a}).eq("id",s):await n.from("students").insert([{school_id:r,full_name:e,class_name:t,student_code:a}]),window.closeModal("addStudentModal"),u(),i("Hazƒ±r","success")};window.saveBook=async()=>{const s=document.getElementById("editBookId").value,e=document.getElementById("newBookTitle").value,a=document.getElementById("newBookAuthor").value,t=document.getElementById("newBookQty").value;if(!e)return i("Ad yazƒ±n","error");s?await n.from("books").update({title:e,author:a,quantity:t}).eq("id",s):await n.from("books").insert([{school_id:r,title:e,author:a,quantity:t}]),window.closeModal("addBookModal"),u(),i("Hazƒ±r","success")};async function _(){const s=document.getElementById("badgePending"),e=document.getElementById("badgeReviews");if(s){const{count:a}=await n.from("transactions").select("*",{count:"exact",head:!0}).eq("school_id",r).eq("status","pending");s.innerText=(a||0).toString(),s.classList.toggle("hidden",a===0)}if(e){const{count:a}=await n.from("transactions").select("*",{count:"exact",head:!0}).eq("school_id",r).not("review_text","is",null).eq("is_review_approved",!1);e.innerText=(a||0).toString(),e.classList.toggle("hidden",a===0)}}window.addStudent=()=>{window.openModal("addStudentModal")};window.addBook=()=>{window.openModal("addBookModal")};window.handleImport=async(s,e)=>{};
